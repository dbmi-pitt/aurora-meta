{% load humanize %}
{% load static %}
{% load search_extras %}

<link rel="stylesheet" type="text/css" href="{% static 'css/jsonTree.css' %}" />
<script src="{% static 'js/jsonTree.js' %}"></script>

<script>
  function replaceSingleQuotes(p1) {
      var s1 = p1.replace(/\'/g, '"')
    return s1
}

  var jsonstr = replaceSingleQuotes("{{search.search_results|safe}}")
  console.log (typeof jsonstr)

/*  
  var json = JSON.parse(jsonstr);

  document.getElementById("results").appendChild(
        renderjson//.set_show_by_default(true)
            //.set_show_to_level(2)
            //.set_sort_objects(true)
            .set_icons('+', '-')
            .set_max_string_length(100)
            (json)
            );

*/
$(document).ready(function() {
  $('.collapse').on('shown.bs.collapse', function() {
    console.log('shown event...');
    $(this).parent().find('.fa-angle-down').removeClass('fa-angle-down').addClass('fa-angle-up');
  }).on('hidden.bs.collapse', function() {
    console.log('hide event...');
    $(this).parent().find('.fa-angle-up').removeClass('fa-angle-up').addClass('fa-angle-down');
  })
});

function viewPortion(portion_id) {
    console.log(portion_id)
    var x = document.getElementById(portion_id);    
    if (x.style.display === "none") {
        x.style.display = "block";
    } else {
        x.style.display = "none";
    }
}
</script>

<span class="sample-labels">Found data associated with {{search.result_total|intcomma}} patient(s)&nbsp;&nbsp;|&nbsp;&nbsp;<i class="fas fa-download" title="Download List to CSV"></i></span>  
<div id="bioaccordion">
{% for result in search.search_results %}
<div>
    <div class="card-header" id="{{result.content.patient_barcode}}_h">

        <button class="btn btn-link" data-toggle="collapse" data-target="#{{result.content.patient_barcode}}" aria-expanded="true" aria-controls="{{result.content.patient_barcode}}">
          <i class="fas fa-user"></i>&nbsp;BCR Patient Barcode: {{result.content.patient_barcode}}&nbsp;|&nbsp;&nbsp;<i class="fas fa-flask"></i>&nbsp;Samples:&nbsp;{{result.content.samples.sample|length}}
        </button>

    </div>
     <div id="{{result.content.patient_barcode}}" class="collapse" aria-labelledby="{{result.content.patient_barcode}}_h" data-parent="#bioaccordion">
      <div class="card-body">
      <span class="sample-labels">Clinical</span>
      <table id="repdata">
        <tbody>
          <tr>
            <td><span class="clinical-labels">BCR Patient Barcode:&nbsp;&nbsp;</span><span>{{result.content.patient_barcode}}</span></td>
            <td><span class="clinical-labels">Deceased?:&nbsp;&nbsp;</span><span>{{result.content.dem_deceased}}</span></td>
          </tr>          
          <tr>
            <td><span class="clinical-labels">Race:&nbsp;&nbsp;</span><span>{{result.content.dem_race}}</span></td>
            <td><span class="clinical-labels">Ethnicity:&nbsp;&nbsp;</span><span>{{result.content.dem_ethnicity}}</span></td>
          </tr>
          <tr>
            <td><span class="clinical-labels">Primary:&nbsp;&nbsp;</span><span>{{result.content.tissue_prim1_histology}}</span></td>          
            <td><span class="clinical-labels">BRCA 1/2 mutation?:&nbsp;&nbsp;</span><span>{{result.content.dem_brca}}</span></td>                        
          </tr>
          <tr>
            <td><span class="clinical-labels">Stage:&nbsp;&nbsp;</span><span>{{result.content.prim_stage_dx}}</span></td>
            <td><span class="clinical-labels">Path TNM:&nbsp;&nbsp;</span><span>{{result.content.ypt}}&nbsp;{{result.content.ypn}}&nbsp;{{result.content.ypm}}</span></td>
          </tr>
          <tr>
            <td><span class="clinical-labels">ER/PR Status:&nbsp;&nbsp;</span><span>{{result.content.prim_er}}/{{result.content.prim_pr}}</span></td>          
            <td><span class="clinical-labels">HER2 Status:&nbsp;&nbsp;</span><span>{{result.content.prim_her2_interpretation}}</span></td>
          </tr>
          <tr>
            <td><span class="clinical-labels">Neoadjuvant Treatment:&nbsp;&nbsp;</span><span>{{result.content.na_txt}}</span></td>          
            <td><span class="clinical-labels">Neoadjuvant Regimen:&nbsp;&nbsp;</span><span>{{result.content.na_chemo_type}}</span></td>          
          </tr>
          <tr>
            <td><span class="clinical-labels">Tumor Final Resection:&nbsp;&nbsp;</span><span>{{result.content.surgpath}}</span></td>
          </tr>
          <tr>            
            <td><span class="clinical-labels">Chemotherapy:&nbsp;&nbsp;</span><span>{{result.content.m1_chemotx}} 
              {% if result.content.m1_chemo1_cycles|length > 0 %}   
                &nbsp;&nbsp;({{result.content.m1_chemo1_cycles}} cycles)
              {% endif %}
            </span></td>
            <td><span class="clinical-labels">Radiation:&nbsp;&nbsp;</span><span>{{result.content.rads_metastatic_yn}}</span></td>            
          </tr>

        </tbody>
      </table>      
      <hr>
      <span class="sample-labels">Samples</span>
      <table class="portion2">
         <thead>
            <tr>
              <th></th>
              <th>BCR Sample Barcode</th>
              <th>Sample Identifier</th>
              <th>Sample Site</th>
              <th>Sample Type</th>
              <th>Tissue Type</th>
              <th>Composition</th>
              <th>Preservation Method</th>
              <th># of Portions</th>
              <th></th>
            </tr>
          </thead>
        <tbody>
          {% for sample in result.content.samples.sample %}
          <tr>
            <td><span><i class="fas fa-flask"></i></span></td>
            <td>{{sample.identifiers.bcr_sample_barcode}}</td>
            <td><span>{{sample.identifiers.aurora_sample_identifier}}</span></td>
            <td><span>{{sample.sample_info.sample_site}}</span></td>
            <td><span>{{sample.sample_info.sample_type}}</span></td>
            <td><span>{{sample.sample_info.tissue_type}}</span></td>
            <td><span>{{sample.sample_info.composition}}</span></td>            
            <td><span>{{sample.sample_info.preservation_method}}</span></td>
            <td>{{sample.portions.portion|length}}</td>
            <td><span>
              <button id="btn_{{sample.identifiers.bcr_sample_barcode}}" title="click to toggle portions panel"><i class="fas fa-list"></i>View</button>
            </span></td>
            </tr>   
            <script>
                  $( "#btn_{{sample.identifiers.bcr_sample_barcode}}" ).click(function() {
                    console.log("toggling portion panel")
                    $( "#portions_{{sample.identifiers.bcr_sample_barcode}}" ).toggle("slow");
                  });
            </script>
          <td colspan="8">           
           <div id="portions_{{sample.identifiers.bcr_sample_barcode}}" style="display: none;"> <!--style="display: none;"-->

            <table class="aliquot">
                    <tbody>
                         <thead>
                          <tr>
                          <th></th>
                          <th>Portion Barcode</th>
                          <th>Aliquots</th>
                        </tr>
                      </thead>
                      {% for po in sample.portions.portion %}
                      <tr>
                        <td class="counterlabel">{{forloop.counter}}</td>
                        <td>{{po.identifiers.bcr_portion_barcode}}</td>
                        <td>
                          <table class="aliquot">
                          <tbody>
                            <thead>
                            <tr>
                                <th>Aliquot Barcode</th>
                                <th>Preservation Method</th>
                                <th>Sequence Method</th>
                                <th>Files</th>
                            </tr>
                            </thead>
                            {% for al in po.analytes.analyte.aliquots.aliquot %}
                            <tr>
                                <!--<td>{{forloop.counter}}</td>-->
                                <td>{{al.identifiers.bcr_aliquot_barcode}}</td>
                                <td>{{al.sample_info.preservation_method}}</td>
                                <td>{% if al.seq_info.seq_method|length > 0 %} 
                                      {{al.seq_info.seq_method}}
                                    {% else %}
                                      <span>None</span>
                                    {% endif %}
                                </td>
                                <td>
                                  {% if al.seq_info.files|length > 0 %}
                                    <ul>
                                    {% for f in al.seq_info.files %}
                                      <li>{{f.level}}&nbsp;|&nbsp;{{f.file_type}}&nbsp;|&nbsp;<a href="#">{{f.file_name}}</a></li>
                                    {% endfor %}
                                    </ul>
                                  {% else %}
                                    <span>None</span>
                                  {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                          </tbody>
                        </table>
                        </td>
                      </tr>
                      {% endfor %}
                    </tbody>
              </table>  
           </div>
          </td>

          {% endfor %}          
        </tbody>
      </table>
    </div>
    </div>
</div>    
{% endfor %}
</div>


