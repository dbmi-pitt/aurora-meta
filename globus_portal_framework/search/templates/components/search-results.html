{% load humanize %}
{% load static %}
{% load search_extras %}

<link rel="stylesheet" type="text/css" href="{% static 'css/jsonTree.css' %}" />
<script src="{% static 'js/jsonTree.js' %}"></script>

<script>
  function replaceSingleQuotes(p1) {
      var s1 = p1.replace(/\'/g, '"')
    return s1
}

  var jsonstr = replaceSingleQuotes("{{search.search_results|safe}}")
  console.log (typeof jsonstr)

/*  
  var json = JSON.parse(jsonstr);

  document.getElementById("results").appendChild(
        renderjson//.set_show_by_default(true)
            //.set_show_to_level(2)
            //.set_sort_objects(true)
            .set_icons('+', '-')
            .set_max_string_length(100)
            (json)
            );

*/
$(document).ready(function() {
  $('.collapse').on('shown.bs.collapse', function() {
    console.log('shown event...');
    $(this).parent().find('.fa-angle-down').removeClass('fa-angle-down').addClass('fa-angle-up');
  }).on('hidden.bs.collapse', function() {
    console.log('hide event...');
    $(this).parent().find('.fa-angle-up').removeClass('fa-angle-up').addClass('fa-angle-down');
  })
});

function viewPortion(portion_id) {
    console.log(portion_id)
    var x = document.getElementById(portion_id);    
    if (x.style.display === "none") {
        x.style.display = "block";
    } else {
        x.style.display = "none";
    }
}
</script>

<span class="sample-labels">Found data associated with {{search.result_total|intcomma}} patient(s)&nbsp;&nbsp;|&nbsp;&nbsp;<i class="fas fa-download" title="Download List to CSV"></i></span>  
<div id="bioaccordion">
{% for result in search.search_results %}
<div>
    <div class="card-header" id="{{result.content.clin.patient_barcode}}_h">

        <button class="btn btn-link" data-toggle="collapse" data-target="#{{result.content.clin.patient_barcode}}" aria-expanded="true" aria-controls="{{result.content.clin.patient_barcode}}">
          <i class="fas fa-user"></i>&nbsp;BCR Patient Barcode: {{result.content.clin.patient_barcode}}&nbsp;|&nbsp;&nbsp;<i class="fas fa-flask"></i>&nbsp;Samples:&nbsp;{{result.content.samples|length}}
        </button>

    </div>
     <div id="{{result.content.clin.patient_barcode}}" class="collapse" aria-labelledby="{{result.content.clin.patient_barcode}}_h" data-parent="#bioaccordion">
      <div class="card-body">
      <span class="sample-labels">Clinical</span>
      <table id="repdata">
        <tbody>
          <tr>
            <td><span class="clinical-labels">BCR Patient Barcode:&nbsp;&nbsp;</span><span>{{result.content.clin.patient_barcode}}</span></td>
            <td><span class="clinical-labels">Deceased?:&nbsp;&nbsp;</span><span>{{result.content.clin.dem_deceased}}</span></td>
          </tr>          
          <tr>
            <td><span class="clinical-labels">Race:&nbsp;&nbsp;</span><span>{{result.content.clin.dem_race}}</span></td>
            <td><span class="clinical-labels">Ethnicity:&nbsp;&nbsp;</span><span>{{result.content.clin.dem_ethnicity}}</span></td>
          </tr>
          <tr>
            <td><span class="clinical-labels">Primary:&nbsp;&nbsp;</span><span>{{result.content.clin.tissue_prim1_histology}}</span></td>          
            <td><span class="clinical-labels">BRCA 1/2 mutation?:&nbsp;&nbsp;</span><span>{{result.content.clin.dem_brca}}</span></td>                        
          </tr>
          <tr>
            <td><span class="clinical-labels">Stage:&nbsp;&nbsp;</span><span>{{result.content.clin.prim_stage_dx}}</span></td>
            <td><span class="clinical-labels">Path TNM:&nbsp;&nbsp;</span><span>{{result.content.clin.ypt}}&nbsp;{{result.content.clin.ypn}}&nbsp;{{result.content.clin.ypm}}</span></td>
          </tr>
          <tr>
            <td><span class="clinical-labels">ER/PR Status:&nbsp;&nbsp;</span><span>{{result.content.clin.prim_er}}/{{result.content.clin.prim_pr}}</span></td>          
            <td><span class="clinical-labels">HER2 Status:&nbsp;&nbsp;</span><span>{{result.content.clin.prim_her2_interpretation}}</span></td>
          </tr>
          <tr>
            <td><span class="clinical-labels">Neoadjuvant Treatment:&nbsp;&nbsp;</span><span>{{result.content.clin.na_txt}}</span></td>          
            <td><span class="clinical-labels">Neoadjuvant Regimen:&nbsp;&nbsp;</span><span>{{result.content.clin.na_chemo_type}}</span></td>          
          </tr>
          <tr>
            <td><span class="clinical-labels">Tumor Final Resection:&nbsp;&nbsp;</span><span>{{result.content.clin.surgpath}}</span></td>
          </tr>
          <tr>            
            <td><span class="clinical-labels">Chemotherapy:&nbsp;&nbsp;</span><span>{{result.content.clin.m1_chemotx}} 
              {% if result.content.clin.m1_chemo1_cycles|length > 0 %}   
                &nbsp;&nbsp;({{result.content.clin.m1_chemo1_cycles}} cycles)
              {% endif %}
            </span></td>
            <td><span class="clinical-labels">Radiation:&nbsp;&nbsp;</span><span>{{result.content.clin.rads_metastatic_yn}}</span></td>            
          </tr>

        </tbody>
      </table>      
      <hr>
      <span class="sample-labels">Samples</span>
      <table class="minimalistBlack">
         <thead>
            <tr>
              <th style="width: 20px;"></th>
              <th>BCR Sample Barcode</th>
              <th>Sample Identifier</th>
              <th>Sample Type</th>
              <th>Tissue Type</th>
              <th>Composition</th>
              <th>Preservation Method</th>
              <th># of Portions</th>
            </tr>
          </thead>
        <tbody>
          {% for sample in result.content.samples %}
          <tr>
            <td><span><i class="fas fa-flask"></i></span></td>
            <td>{{sample.identifiers.bcr_sample_barcode}}</td>
            <td><span>{{sample.identifiers.aurora_sample_identifier}}</span></td>
            <td><span>{{sample.sample_info.sample_type}}</span></td>
            <td><span>{{sample.sample_info.tissue_type}}</span></td>
            <td><span>{{sample.sample_info.composition}}</span></td>            
            <td><span>{{sample.sample_info.preservation_method}}</span></td>
            <td>{{sample.portion|length}}&nbsp;&nbsp;<button id="btn_{{sample.identifiers.bcr_sample_barcode}}" title="click to toggle portions panel"><i class="fas fa-list"></i>Show/Hide</button></td>
            </tr>   
            <script>
                  $( "#btn_{{sample.identifiers.bcr_sample_barcode}}" ).click(function() {
                    console.log("toggling portion panel")
                    $( "#portions_{{sample.identifiers.bcr_sample_barcode}}" ).toggle("slow");
                  });
            </script>
          <td colspan="8" style="padding: 0px;">           
           <div id="portions_{{sample.identifiers.bcr_sample_barcode}}" style="display: none;"> <!--style="display: none;"-->

            <table>
                    <tbody>
                         <thead>
                          <tr bgcolor="#437FC9">
                          <th></th>
                          <th>Portion Barcode</th>
                          <th>Analytes</th>
                        </tr>
                      </thead>
                      {% for po in sample.portion %}
                      <tr>
                        <td class="counterlabel">{{forloop.counter}}</td>
                        <td>{{po.identifiers.bcr_portion_barcode}}</td>
                        <td>
                          <table>
                          <tbody>
                            <thead>
                            <tr bgcolor="#85acdb">
                                <th>Analyte Barcode</th>
                                <th>Analyte Type</th>
                                <th>Aliquots</th>
                            </tr>
                            </thead>
                            {% for al in po.analyte %}
                            <tr>
                                <!--<td>{{forloop.counter}}</td>-->
                                <td>{{al.identifiers.bcr_analyte_barcode}}</td>
                                <td>{{al.identifiers.analyte_type}}</td>
                                <td>
                                  <table>
                                 <tbody>
                                  <thead>
                                    <tr bgcolor="#a7bad1">
                                      <th>Aliquot Barcode</th>
                                      <th>Analysis Type</th>
                                      <th>Sequence Type</th>
                                      <th>Files</th>
                                    </tr>
                                  </thead>                       
                                  {% for aq in al.aliquot %}
                                    {% if aq.seq_info.WES %}   <!-- check for a WES -->
                                      <tr>
                                        <td>{{aq.identifiers.bcr_aliquot_barcode}}</td>                                      
                                          <td>{{aq.seq_info.WES.analysis_type}}</td>
                                          <td>{{aq.seq_info.WES.seq_type}}</td>
                                          <td>
                                          {% if aq.seq_info.WES.files|length > 0 %}
                                          <ul>
                                            {% for f in aq.seq_info.WES.files %}
                                              <li><b>{{f.level}}</b>&nbsp;|&nbsp;<b>{{f.file_type}}</b>&nbsp;|&nbsp;{{f.file_names}}</li>
                                            {% endfor %}
                                          </ul>
                                          {% else %}
                                            <span>None</span>
                                          {% endif %}
                                          </td>
                                      </tr>
                                    {% endif %}
                                    {% if aq.seq_info.WGS %}   <!-- check for a WSG -->
                                      <tr>
                                        <td>{{aq.identifiers.bcr_aliquot_barcode}}</td>                                      
                                          <td>{{aq.seq_info.WGS.analysis_type}}</td>
                                          <td>{{aq.seq_info.WGS.seq_type}}</td>
                                          <td>
                                          {% if aq.seq_info.WGS.files|length > 0 %}
                                          <ul>
                                            {% for f in aq.seq_info.WGS.files %}
                                              <li><b>{{f.level}}</b>&nbsp;|&nbsp;<b>{{f.file_type}}</b>&nbsp;|&nbsp;{{f.file_names}}</li>
                                            {% endfor %}
                                          </ul>
                                          {% else %}
                                            <span>None</span>
                                          {% endif %}
                                          </td>
                                      </tr>
                                    {% endif %}
                                    {% if aq.seq_info.WES == None and aq.seq_info.WGS == None %}
                                    <tr>
                                      <td>{{aq.identifiers.bcr_aliquot_barcode}}</td>
                                      <td>{{aq.seq_info.analysis_type}}</td>
                                      <td>{{aq.seq_info.seq_type}}</td>
                                      <td>
                                        {% if aq.seq_info.files|length > 0 %}
                                          <ul>
                                            {% for f in aq.seq_info.files %}
                                              <li><b>{{f.level}}</b>&nbsp;|&nbsp;<b>{{f.file_type}}</b>&nbsp;|&nbsp;{{f.file_names}}</li>
                                            {% endfor %}
                                          </ul>
                                        {% else %}
                                          <span>None</span>
                                        {% endif %}
                                      </td>
                                    </tr>
                                    {% endif %}
                                  {% endfor %}
                                </tbody>
                                </table>
                              </td>
                            </tr>
                            {% endfor %}
                          </tbody>
                        </table>
                        </td>
                      </tr>
                      {% endfor %}
                    </tbody>
              </table>  
           </div>
          </td>

          {% endfor %}          
        </tbody>
      </table>
    </div>
    </div>
</div>    
{% endfor %}
</div>


