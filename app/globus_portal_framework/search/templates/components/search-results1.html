{% load humanize %}
{% load static %}
{% load search_extras %}

<link rel="stylesheet" type="text/css" href="{% static 'css/jsonTree.css' %}" />
<script src="{% static 'js/jsonTree.js' %}"></script>

<script>
  function replaceSingleQuotes(p1) {
      var s1 = p1.replace(/\'/g, '"')
    return s1
}

  var jsonstr = replaceSingleQuotes("{{search.search_results|safe}}")
  console.log (typeof jsonstr)

/*  
  var json = JSON.parse(jsonstr);

  document.getElementById("results").appendChild(
        renderjson//.set_show_by_default(true)
            //.set_show_to_level(2)
            //.set_sort_objects(true)
            .set_icons('+', '-')
            .set_max_string_length(100)
            (json)
            );

*/
</script>

<span class="sample-labels">Found data associated with {{search.result_total|intcomma}} patient(s)</span>  
<div id="bioaccordion">
{% for result in search.search_results %}
<div>
    <div class="card-header" id="{{result.content.patient_barcode}}_h">

        <button class="btn btn-link" data-toggle="collapse" data-target="#{{result.content.patient_barcode}}" aria-expanded="true" aria-controls="{{result.content.patient_barcode}}">
          <i class="fas fa-user"></i>&nbsp;BCR Patient Barcode: {{result.content.patient_barcode}}&nbsp;|&nbsp;&nbsp;<i class="fas fa-flask"></i>&nbsp;Samples:&nbsp;{{result.content.samples.sample|length}}
        </button>

    </div>
     <div id="{{result.content.patient_barcode}}" class="collapse" aria-labelledby="{{result.content.patient_barcode}}_h" data-parent="#bioaccordion">
      <div class="card-body">
      <span class="sample-labels">Clinical</span>
      <table id="repdata">
        <tbody>
          <tr>
            <td><span class="clinical-labels">BCR Patient Barcode:&nbsp;&nbsp;</span><span>{{result.content.patient_barcode}}</span></td>
            <td><span class="clinical-labels">Deceased?:&nbsp;&nbsp;</span><span>{{result.content.dem_deceased}}</span></td>
          </tr>          
          <tr>
            <td><span class="clinical-labels">Race:&nbsp;&nbsp;</span><span>{{result.content.dem_race}}</span></td>
            <td><span class="clinical-labels">Ethnicity:&nbsp;&nbsp;</span><span>{{result.content.dem_ethnicity}}</span></td>
          </tr>
          <tr>
            <td><span class="clinical-labels">Primary:&nbsp;&nbsp;</span><span>{{result.content.tissue_prim1_histology}}</span></td>          
            <td><span class="clinical-labels">BRCA 1/2 mutation?:&nbsp;&nbsp;</span><span>{{result.content.dem_brca}}</span></td>                        
          </tr>
          <tr>
            <td><span class="clinical-labels">Stage:&nbsp;&nbsp;</span><span>{{result.content.prim_stage_dx}}</span></td>
            <td><span class="clinical-labels">Path TNM:&nbsp;&nbsp;</span><span>{{result.content.ypt}}&nbsp;{{result.content.ypn}}&nbsp;{{result.content.ypm}}</span></td>
          </tr>
          <tr>
            <td><span class="clinical-labels">ER/PR Status:&nbsp;&nbsp;</span><span>{{result.content.prim_er}}/{{result.content.prim_pr}}</span></td>          
            <td><span class="clinical-labels">HER2 Status:&nbsp;&nbsp;</span><span>{{result.content.prim_her2_interpretation}}</span></td>
          </tr>
          <tr>
            <td><span class="clinical-labels">Neoadjuvant Treatment:&nbsp;&nbsp;</span><span>{{result.content.na_txt}}</span></td>          
            <td><span class="clinical-labels">Neoadjuvant Regimen:&nbsp;&nbsp;</span><span>{{result.content.na_chemo_type}}</span></td>          
          </tr>
          <tr>
            <td><span class="clinical-labels">Tumor Final Resection:&nbsp;&nbsp;</span><span>{{result.content.surgpath}}</span></td>
          </tr>
          <tr>            
            <td><span class="clinical-labels">Chemotherapy:&nbsp;&nbsp;</span><span>{{result.content.m1_chemotx}} 
              {% if result.content.m1_chemo1_cycles|length > 0 %}   
                &nbsp;&nbsp;({{result.content.m1_chemo1_cycles}} cycles)
              {% endif %}
            </span></td>
            <td><span class="clinical-labels">Radiation:&nbsp;&nbsp;</span><span>{{result.content.rads_metastatic_yn}}</span></td>            
          </tr>

        </tbody>
      </table>      
      <hr>
      <span class="sample-labels">Samples</span>
      <table class="samples3">
         <thead>
            <tr>
              <th></th>
              <th>BCR Sample Barcode</th>
              <th>Sample Identifier</th>
              <th>Sample Type</th>
              <th>Tissue Type</th>
              <th>Composition</th>
              <th>Preservation Method</th>
              <th># of Portions</th>
              <th></th>
            </tr>
          </thead>
        <tbody>
          {% for sample in result.content.samples.sample %}
          <tr>
            <td><span><i class="fas fa-flask"></i></span></td>
            <td>{{sample.identifiers.bcr_sample_barcode}}</td>
            <td><span>{{sample.identifiers.aurora_sample_identifier}}</span></td>
            <td><span>{{sample.sample_info.sample_type}}</span></td>
            <td><span>{{sample.sample_info.tissue_type}}</span></td>
            <td><span>{{sample.sample_info.composition}}</span></td>            
            <td><span>{{sample.sample_info.preservation_method}}</span></td>
            <td><span>{{sample.portions.portion|length}}</span></td>
            <td><span><a id="showportions_{{sample.identifiers.aurora_sample_identifier}}" href="#" onclick="$('#portions_{{sample.identifiers.aurora_sample_identifier}}').dialog('open');"><i class="fas fa-sitemap"></i></a></span></td>
           <div id="portions_{{sample.identifiers.aurora_sample_identifier}}" class="card" title="Portions for sample {{sample.identifiers.aurora_sample_identifier}}" style="display:none;">
                <div id="wrapper">
                  <div id="tree"></div>
                </div>                 
            </div>
              <script>
        $(function() {
                                    $("#portions_{{sample.identifiers.aurora_sample_identifier}}").dialog({
                                                autoOpen: false,
                                                show: {
                                                            effect: "blind",
                                                            duration: 1000
                                                },
                                        hide: {
                                                    effect: "explode",
                                                    duration: 1000
                                        },
                                                width:500,
                                                height:500,
                                                position: { my: "center", at: "center", of: window }
                                    });
                                    $("#showportions_{{sample.identifiers.aurora_sample_identifier}}").on("click", function() {
                                        var treewrapper = document.getElementById("wrapper");                                        
                                        var dataStr = replaceSingleQuotes("{{sample.portions.portion|safe}}");
                                        console.log(dataStr)
                                        try {
                                            var data = JSON.parse(dataStr);
                                            var tree = jsonTree.create(data, treewrapper);
                                        } catch (e) {}
                                        
                                        $("#portions_{{sample.identifiers.aurora_sample_identifier}}").dialog("open");
                                    });
                        });
              </script>
            </tr>              
          {% endfor %}          
        </tbody>
      </table>
    </div>
    </div>
</div>    
{% endfor %}
</div>
