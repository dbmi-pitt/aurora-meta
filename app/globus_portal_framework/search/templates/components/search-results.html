{% load humanize %}
{% load static %}
{% load search_extras %}

<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
<script>
function replaceSingleQuotes(p1) {
      var s1 = p1.replace(/\'/g, '"')
    return s1
}

function replaceQuotes(p1) {
      var s1 = p1.replace(/\'/g, '')
    return s1
}

function replaceCommas(p1) {
      var s1 = p1.replace(/,/g,';')
    return s1
}

function replaceEndStuff(p1) {
      var s1 = p1.replace(/\n/g,'')
    return s1
}

  var jsonstr = replaceSingleQuotes("{{search.search_results|safe}}")
  console.log (typeof jsonstr)

/*  
  var json = JSON.parse(jsonstr);

  document.getElementById("results").appendChild(
        renderjson//.set_show_by_default(true)
            //.set_show_to_level(2)
            //.set_sort_objects(true)
            .set_icons('+', '-')
            .set_max_string_length(100)
            (json)
            );

*/
$(document).ready(function() {
  $('.collapse').on('shown.bs.collapse', function() {
    console.log('shown event...');
    $(this).parent().find('.fa-angle-down').removeClass('fa-angle-down').addClass('fa-angle-up');
  }).on('hidden.bs.collapse', function() {
    console.log('hide event...');
    $(this).parent().find('.fa-angle-up').removeClass('fa-angle-up').addClass('fa-angle-down');
  })
});

function viewPortion(portion_id) {
    console.log(portion_id)
    var x = document.getElementById(portion_id);    
    if (x.style.display === "none") {
        x.style.display = "block";
    } else {
        x.style.display = "none";
    }
}

function convertToCSV(objArray) {
    var array = typeof objArray != 'object' ? JSON.parse(objArray) : objArray;
    var str = '';
    for (var i = 0; i < array.length; i++) {
      var line = '';
      for (var index in array[i]) {
        if (line != '') line += ','
        line += array[i][index];
      }
      str += line + '\r\n';
    }
    return str;
}
function exportCSVFile(specHeaders, items, fileTitle) {
    if (specHeaders) {
      items.unshift(specHeaders);
    }
    // Convert Object to JSON
    var jsonObject = JSON.stringify(items);
    var csv = this.convertToCSV(jsonObject);
    var exportedFilenmae = fileTitle + '.csv' || 'export.csv';
    var blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    if (navigator.msSaveBlob) { // IE 10+
      navigator.msSaveBlob(blob, exportedFilenmae);
    } else {
      var link = document.createElement("a");
      if (link.download !== undefined) { // feature detection
        // Browsers that support HTML5 download attribute
        var url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", exportedFilenmae);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }
    }
}
</script>
{% if search.search_results  %}
<script>

/* NEED A BETTER SOLUTION FOR EXPORTING!!!  */
  var clinFormatted = [{% for result in search.search_results %}
      {
        patient_barcode: '{{ result.content.clin.patient_barcode }}',
        dem_deceased: '{{result.content.clin.dem_deceased}}',
        dem_race: '{{result.content.clin.dem_race}}',
        dem_ethnicity: '{{result.content.clin.dem_ethnicity}}',
        tissue_prim1_histology: '{{result.content.clin.tissue_prim1_histology}}',
        dem_brca: '{{result.content.clin.dem_brca}}',
        prim_stage_dx: '{{result.content.clin.prim_stage_dx}}',
        ypt: '{{result.content.clin.ypt}}',
        ypn: '{{result.content.clin.ypn}}',
        ypm: '{{result.content.clin.ypm}}',
        prim_er: '{{result.content.clin.prim_er}}',
        prim_pr: '{{result.content.clin.prim_pr}}',
        prim_her2_interpretation: '{{result.content.clin.prim_her2_interpretation}}',
        na_txt: '{{result.content.clin.na_txt}}',
        na_chemo_type: '{{result.content.clin.na_chemo_type}}',
        surgpath: '{{result.content.clin.surgpath}}',
        m1_chemotx: '{{result.content.clin.m1_chemotx}}',
        m1_chemo1_cycles: '{{result.content.clin.m1_chemo1_cycles}}',
        rads_metastatic_yn: '{{result.content.clin.rads_metastatic_yn}}'
      },
        {% if forloop.last %}
            ];
        {% endif %}
      {% endfor %}

  

  var specFormatted = [{% for result in search.search_results %}
          {% for sample in result.content.samples %}
           {
              patient_barcode: '{{ result.content.clin.patient_barcode }}',
              bcr_sample_barcode:  '{{ sample.identifiers.bcr_sample_barcode }}',
              aurora_sample_identifier: '{{ sample.identifiers.aurora_sample_identifier }}',
              sample_type: '{{ sample.sample_info.sample_type }}',
              composition: '{{sample.sample_info.composition}}',
              preservation_method: '{{sample.sample_info.preservation_method}}'
            },
          {% endfor %}
          {% if forloop.last %}
            ];
          {% endif %}
          {% endfor %}


  var analyteFormatted = [ {% for result in search.search_results %}
          {% for sample in result.content.samples %}
          {% for po in sample.portion %}
           {% for al in po.analyte %}
           {% for aq in al.aliquot %}
           {
              patient_barcode: '{{ result.content.clin.patient_barcode }}',
              bcr_sample_barcode:  '{{ sample.identifiers.bcr_sample_barcode }}',
              bcr_analyte_barcode: '{{ al.identifiers.bcr_analyte_barcode }}',
              analyte_type:  '{{ al.identifiers.analyte_type }}',
              bcr_aliquot_barcode: '{{aq.identifiers.bcr_aliquot_barcode}}',
              seq_type: '{{aq.seq_info.seq_type}}',
              seq_files: replaceEndStuff(replaceCommas(replaceQuotes("{{aq.seq_info.files|safe}}")))
            },
           {% endfor %}
          {% endfor %}
          {% endfor %}
          {% endfor %}
          {% if forloop.last %}
            ];
          {% endif %}
          {% endfor %}

  var clinHeaders = {
        patient_barcode: "Patient Barcode",
        dem_deceased: "Deceased",
        dem_race: "Race",
        dem_ethnicity: "Ethnicity",
        tissue_prim1_histology: "Histology",
        dem_brca: "BRCA Mutation",
        prim_stage_dx: "Stage",
        ypt: "Path T",
        ypn: "Path N",
        ypm: "Path M",
        prim_er: "ER",
        prim_pr: "PR",
        prim_her2_interpretation: "HER2 Intepretation",
        na_txt: "Neoadjuvant Treatment",
        na_chemo_type: "Neoadjuvant Regimen",
        surgpath: "Tumor Final Resection",
        m1_chemotx: "Chemotherapy",
        m1_chemo1_cycles: "# of Cycles",
        rads_metastatic_yn: "Radiation"
      };

  var specHeaders = {
        patient_barcode: "Patient Barcode",
        bcr_sample_barcode: "BCR Sample Barcode",
        aurora_sample_identifier: "Aurora Sample Identifier",
        sample_type: "Sample Type",
        composition: "Composition",
        preservation_method: "Preservation Method"
      };

  var analyteHeaders = {
        patient_barcode: "Patient Barcode",
        bcr_sample_barcode: "BCR Sample Barcode",    
        bcr_analyte_barcode: "Analyte Barcode",
        analyte_type: "Analyte Type",
        bcr_aliquot_barcode: "BCR Aliquot Barcode",
        seq_type: "Sequence Type",
        seq_files: "Files"
      };


</script>
{% endif %}
<span class="sample-labels">{{search.result_total.value|intcomma}} cases found</span>
<div class="float-right">
<button type="button" class="btn btn-secondary btn-sm" onClick="exportCSVFile(clinHeaders, clinFormatted, 'aurora_clinical')"><i class="fas fa-download"></i>&nbsp;&nbsp;Clinical</button>&nbsp;&nbsp;
<button type="button" class="btn btn-secondary btn-sm" onClick="exportCSVFile(specHeaders, specFormatted, 'aurora_samples')"><i class="fas fa-download"></i>&nbsp;&nbsp;Biospecimen</button>&nbsp;&nbsp;<button type="button" class="btn btn-secondary btn-sm" onClick="exportCSVFile(analyteHeaders, analyteFormatted, 'aurora_analyte')"><i class="fas fa-download"></i>&nbsp;&nbsp;Analytes</button>
</div>
<hr>
<hr>
<div class="resultscrollarea">
{% for result in search.search_results %}
<!-- <div> -->
    <div class="card-header" id="{{result.content.clin.patient_barcode}}_h">

        <button class="btn btn-link" data-toggle="collapse" data-target="#{{result.content.clin.patient_barcode}}" aria-expanded="true" aria-controls="{{result.content.clin.patient_barcode}}">
          <i class="fas fa-user"></i>&nbsp;BCR Patient Barcode: {{result.content.clin.patient_barcode}}&nbsp;|&nbsp;&nbsp;<i class="fas fa-flask"></i>&nbsp;Samples:&nbsp;{{result.content.samples|length}}
        </button>

    </div>
     <div id="{{result.content.clin.patient_barcode}}" class="collapse" aria-labelledby="{{result.content.clin.patient_barcode}}_h" data-parent="#bioaccordion">
      <div class="card-body">
      <span class="sample-labels">Clinical</span>
      <table id="repdata">
        <tbody>
          <tr>
            <td><span class="clinical-labels">BCR Patient Barcode:&nbsp;&nbsp;</span><span>{{result.content.clin.patient_barcode}}</span></td>
            <td><span class="clinical-labels">Deceased?:&nbsp;&nbsp;</span><span>{{result.content.clin.dem_deceased}}</span></td>
          </tr>          
          <tr>
            <td><span class="clinical-labels">Race:&nbsp;&nbsp;</span><span>{{result.content.clin.dem_race}}</span></td>
            <td><span class="clinical-labels">Ethnicity:&nbsp;&nbsp;</span><span>{{result.content.clin.dem_ethnicity}}</span></td>
          </tr>
          <tr>
            <td><span class="clinical-labels">Primary:&nbsp;&nbsp;</span><span>{{result.content.clin.tissue_prim1_histology}}</span></td>          
            <td><span class="clinical-labels">BRCA 1/2 mutation?:&nbsp;&nbsp;</span><span>{{result.content.clin.dem_brca}}</span></td>                        
          </tr>
          <tr>
            <td><span class="clinical-labels">Stage:&nbsp;&nbsp;</span><span>{{result.content.clin.prim_stage_dx}}</span></td>
            <td><span class="clinical-labels">Path TNM:&nbsp;&nbsp;</span><span>{{result.content.clin.ypt}}&nbsp;{{result.content.clin.ypn}}&nbsp;{{result.content.clin.ypm}}</span></td>
          </tr>
          <tr>
            <td><span class="clinical-labels">ER/PR Status:&nbsp;&nbsp;</span><span>{{result.content.clin.prim_er}}/{{result.content.clin.prim_pr}}</span></td>          
            <td><span class="clinical-labels">HER2 Status:&nbsp;&nbsp;</span><span>{{result.content.clin.prim_her2_interpretation}}</span></td>
          </tr>
          <tr>
            <td><span class="clinical-labels">Neoadjuvant Treatment:&nbsp;&nbsp;</span><span>{{result.content.clin.na_txt}}</span></td>          
            <td><span class="clinical-labels">Neoadjuvant Regimen:&nbsp;&nbsp;</span><span>{{result.content.clin.na_chemo_type}}</span></td>          
          </tr>
          <tr>
            <td><span class="clinical-labels">Tumor Final Resection:&nbsp;&nbsp;</span><span>{{result.content.clin.surgpath}}</span></td>
          </tr>
          <tr>            
            <td><span class="clinical-labels">Chemotherapy:&nbsp;&nbsp;</span><span>{{result.content.clin.m1_chemotx}} 
              {% if result.content.clin.m1_chemo1_cycles|length > 0 %}   
                &nbsp;&nbsp;({{result.content.clin.m1_chemo1_cycles}} cycles)
              {% endif %}
            </span></td>
            <td><span class="clinical-labels">Radiation:&nbsp;&nbsp;</span><span>{{result.content.clin.rads_metastatic_yn}}</span></td>            
          </tr>

        </tbody>
      </table>      
      <hr>
      <span class="sample-labels">Samples</span>
      <table class="minimalistBlack">
         <thead>
            <tr>
              <th style="width: 20px;"></th>
              <th>BCR Sample Barcode</th>
              <th>Sample Identifier</th>
              <th>Sample Type</th>
              <th>Tissue Type</th>
              <th>Composition</th>
              <th>Preservation Method</th>
              <th># of Portions</th>
            </tr>
          </thead>
        <tbody>
          {% for sample in result.content.samples %}
          <tr>
            <td><span><i class="fas fa-flask"></i></span></td>
            <td>{{sample.identifiers.bcr_sample_barcode}}</td>
            <td><span>{{sample.identifiers.aurora_sample_identifier}}</span></td>
            <td><span>{{sample.sample_info.sample_type}}</span></td>
            <td><span>{{sample.sample_info.tissue_type}}</span></td>
            <td><span>{{sample.sample_info.composition}}</span></td>            
            <td><span>{{sample.sample_info.preservation_method}}</span></td>
            <td>{{sample.portion|length}}&nbsp;&nbsp;<button id="btn_{{sample.identifiers.bcr_sample_barcode}}" title="click to toggle portions panel"><i class="fas fa-list"></i>Show/Hide</button></td>
            </tr>   
            <script>
                  $( "#btn_{{sample.identifiers.bcr_sample_barcode}}" ).click(function() {
                    console.log("toggling portion panel")
                    $( "#portions_{{sample.identifiers.bcr_sample_barcode}}" ).toggle("slow");
                  });
            </script>
          <td colspan="8" style="padding: 0px;">           
           <div id="portions_{{sample.identifiers.bcr_sample_barcode}}" style="display: none;"> <!--style="display: none;"-->

            <table>
                    <tbody>
                         <thead>
                          <tr bgcolor="#437FC9">
                          <th></th>
                          <th>Portion Barcode</th>
                          <th>Analytes</th>
                        </tr>
                      </thead>
                      {% for po in sample.portion %}
                      <tr>
                        <td class="counterlabel">{{forloop.counter}}</td>
                        <td>{{po.identifiers.bcr_portion_barcode}}</td>
                        <td>
                          <table>
                          <tbody>
                            <thead>
                            <tr bgcolor="#85acdb">
                                <th>Analyte Barcode</th>
                                <th>Analyte Type</th>
                                <th>Aliquots</th>
                            </tr>
                            </thead>
                            {% for al in po.analyte %}
                            <tr>
                                <!--<td>{{forloop.counter}}</td>-->
                                <td>{{al.identifiers.bcr_analyte_barcode}}</td>
                                <td>{{al.identifiers.analyte_type}}</td>
                                <td>
                                  <table>
                                 <tbody>
                                  <thead>
                                    <tr bgcolor="#a7bad1">
                                      <th>Aliquot Barcode</th>
                                      <th>Analysis Type</th>
                                      <th>Sequence Type</th>
                                      <th>Files</th>
                                    </tr>
                                  </thead>                       
                                  {% for aq in al.aliquot %}
                                    {% if aq.seq_info.WES %}   <!-- check for a WES -->
                                      <tr>
                                        <td>{{aq.identifiers.bcr_aliquot_barcode}}</td>                                      
                                          <td>{{aq.seq_info.WES.analysis_type}}</td>
                                          <td>{{aq.seq_info.WES.seq_type}}</td>
                                          <td>
                                          {% if aq.seq_info.WES.files|length > 0 %}
                                          <ul>
                                            {% for f in aq.seq_info.WES.files %}
                                              <li><b>{{f.level}}</b>&nbsp;|&nbsp;<b>{{f.file_type}}</b>&nbsp;|&nbsp;{{f.file_names}}</li>
                                            {% endfor %}
                                          </ul>
                                          {% else %}
                                            <span>None</span>
                                          {% endif %}
                                          </td>
                                      </tr>
                                    {% endif %}
                                    {% if aq.seq_info.WGS %}   <!-- check for a WSG -->
                                      <tr>
                                        <td>{{aq.identifiers.bcr_aliquot_barcode}}</td>                                      
                                          <td>{{aq.seq_info.WGS.analysis_type}}</td>
                                          <td>{{aq.seq_info.WGS.seq_type}}</td>
                                          <td>
                                          {% if aq.seq_info.WGS.files|length > 0 %}
                                          <ul>
                                            {% for f in aq.seq_info.WGS.files %}
                                              <li><b>{{f.level}}</b>&nbsp;|&nbsp;<b>{{f.file_type}}</b>&nbsp;|&nbsp;{{f.file_names}}</li>
                                            {% endfor %}
                                          </ul>
                                          {% else %}
                                            <span>None</span>
                                          {% endif %}
                                          </td>
                                      </tr>
                                    {% endif %}
                                    {% if aq.seq_info.WES == None and aq.seq_info.WGS == None %}
                                    <tr>
                                      <td>{{aq.identifiers.bcr_aliquot_barcode}}</td>
                                      <td>{{aq.seq_info.analysis_type}}</td>
                                      <td>{{aq.seq_info.seq_type}}</td>
                                      <td>
                                        {% if aq.seq_info.files|length > 0 %}
                                          <ul>
                                            {% for f in aq.seq_info.files %}
                                              <li><b>{{f.level}}</b>&nbsp;|&nbsp;<b>{{f.file_type}}</b>&nbsp;|&nbsp;{{f.file_names}}</li>
                                            {% endfor %}
                                          </ul>
                                        {% else %}
                                          <span>None</span>
                                        {% endif %}
                                      </td>
                                    </tr>
                                    {% endif %}
                                  {% endfor %}
                                </tbody>
                                </table>
                              </td>
                            </tr>
                            {% endfor %}
                          </tbody>
                        </table>
                        </td>
                      </tr>
                      {% endfor %}
                    </tbody>
              </table>  
           </div>
          </td>

          {% endfor %}          
        </tbody>
      </table>
    </div>
    </div>
<!--</div>    -->
{% endfor %}
</div>
